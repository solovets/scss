<!doctype html>
<html lang="en">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">

    <title>Hello, world!</title>
</head>
<body>
<div class="container">
    <form id="liqpayData" class="mb-4">
        <input type="hidden" name="version" value="3" readonly>

        <div class="form-group row">
            <label for="public_key" class="col-sm-2 col-form-label">Public key</label>
            <div class="col-sm-6">
                <input class="form-control" type="text" id="public_key" name="public_key" value="">
            </div>
        </div>

        <div class="form-group row">
            <label for="private_key" class="col-sm-2 col-form-label">Private key</label>
            <div class="col-sm-6">
                <input class="form-control" type="text" id="private_key" name="private_key" value="">
            </div>
        </div>

        <hr>

        <div class="form-group row">
            <div class="col-sm-2">Типы платежей</div>
            <div class="col-sm-10">

                <div class="form-check">
                    <input class="form-check-input" name="action" type="checkbox" value="subscribe" id="defaultCheck1">
                    <label class="form-check-label" for="defaultCheck1">
                        Подписка
                    </label>
                </div>

                <div class="form-check">
                    <input class="form-check-input" name="action" type="checkbox" value="paydonate" id="defaultCheck2">
                    <label class="form-check-label" for="defaultCheck2">
                        Разовый платеж
                    </label>
                </div>

            </div>
        </div>

        <hr>

        <div class="form-group row">
            <div class="col-sm-2">Варианты суммы пожертвований</div>
            <div class="col-sm-10">

                <div class="form-check">
                    <input class="form-check-input" name="amount" type="checkbox" value="1" id="defaultCheck3">
                    <label class="form-check-label" for="defaultCheck3">
                        1
                    </label>
                </div>

                <div class="form-check">
                    <input class="form-check-input" name="amount" type="checkbox" value="10" id="defaultCheck4">
                    <label class="form-check-label" for="defaultCheck4">
                        10
                    </label>
                </div>

                <div class="form-check">
                    <input class="form-check-input" name="amount" type="checkbox" value="20" id="defaultCheck5">
                    <label class="form-check-label" for="defaultCheck5">
                        20
                    </label>
                </div>

                <div class="form-check">
                    <input class="form-check-input" name="amount" type="checkbox" value="50" id="defaultCheck6">
                    <label class="form-check-label" for="defaultCheck6">
                        50
                    </label>
                </div>

                <div class="form-check">
                    <input class="form-check-input" name="amount" type="checkbox" value="100" id="defaultCheck7">
                    <label class="form-check-label" for="defaultCheck7">
                        100
                    </label>
                </div>

                <div class="form-check">
                    <input class="form-check-input" name="amount" type="checkbox" value="200" id="defaultCheck8">
                    <label class="form-check-label" for="defaultCheck8">
                        200
                    </label>
                </div>

                <div class="form-check">
                    <input class="form-check-input" name="amount" type="checkbox" value="500" id="defaultCheck9">
                    <label class="form-check-label" for="defaultCheck9">
                        500
                    </label>
                </div>

            </div>
        </div>

        <hr>

        <input type="hidden" name="currency" value="UAH" readonly>

        <div class="form-group row">
            <label for="description" class="col-sm-2 col-form-label">Описание платежа</label>
            <div class="col-sm-6">
                <input class="form-control" type="text" id="description" name="description" value="">
            </div>
        </div>

        <hr>

        <input class="btn btn-success" type="submit" onclick="generateForm(event)" value="Сгенерировать код виджета">

    </form>

    <div class="row">
        <div class="col-12">
            <textarea class="form-control" id="result" rows="5"></textarea>
        </div>
    </div>

</div>

<script src="http://cdn.rawgit.com/h2non/jsHashes/master/hashes.js"></script>
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js" integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous"></script>

<script>

    function getData(controls) {
        var arr = [];

        if (controls.length) {
            for (var i = 0; i < controls.length; i++) {
                if (controls[i].checked) {
                    arr.push(controls[i].value);
                }
            }
        } else {
            if (controls.checked) arr.push(controls.value);
        }

        return arr;
    }

    function setData(name, values) {
        var str = '';
        for (var i = 0; i < values.length; i++) {
            str += '<label\><input type="radio" name="' + name + '" value="' + values[i] + '"' + (i === 0 ? ' checked':'') + '\>' + values[i] + '</label\>';
        }
        return str;
    }

    function generateForm(ev) {
        ev.preventDefault();
        ev.stopPropagation();

        var SHA1 = new Hashes.SHA1;
        var liqpayData = document.getElementById('liqpayData').elements;
        var actions = getData(liqpayData.action);
        var amounts = getData(liqpayData.amount);
        var formVariants = {};
        var result = document.getElementById('result');

        if (actions.length > 0 && amounts.length > 0) {

            for (var actionIndex = 0; actionIndex < actions.length; actionIndex++) {

                formVariants[actions[actionIndex]] = {};

                for (var amountIndex = 0; amountIndex < amounts.length; amountIndex++) {

                    var data = btoa(JSON.stringify({
                        public_key: liqpayData.public_key.value,
                        version: liqpayData.version.value,
                        action: actions[actionIndex],
                        amount: amounts[amountIndex],
                        currency: liqpayData.currency.value,
                        description: liqpayData.description.value,
                        order_id: '000001'

                    }));

                    var signature = SHA1.b64(liqpayData.private_key.value + data + liqpayData.private_key.value);

                    formVariants[actions[actionIndex]][amounts[amountIndex]] = {
                        data: data,
                        signature: signature
                    };
                }
            }
        }

        var result_actions = setData('action', actions);
        var result_amounts = setData('amount', amounts);

        var result_settings_form = '<div id="dadonateform"\><form id="dadonateform_form" onchange="dadonateformchange(event)"\>' +
            '<div id="dadonateform_description"\>test</div\>' +
            '<div id="dadonateform_action"\>' +
            result_actions +
            '</div\>' +
            '<div id="dadonateform_amount"\>' +
            result_amounts +
            '</div\>' +
            '</form\>';

        var result_liqpay_form = '<div\>' +
            '<form method="POST" accept-charset="UTF-8" action="https://www.liqpay.ua/api/3/checkout"\>' +
            '<input id="liqpayFormData" type="hidden" name="data" value=""\>' +
            '<input id="liqpayFormSignature" type="hidden" name="signature" value=""\>' +
            '<input type="submit" name="btn_text" value="Отправить"\>' +
            '</form\>' +
            '</div\></div\>';

        var resultScript = '<script\>' +
            'var DADonateFormData=' + JSON.stringify(formVariants) + ';' +
            'function DADonateFormSetData() {' +
            'var DADonateForm=document.getElementById("dadonateform_form").elements;' +
            'document.getElementById("liqpayFormData").setAttribute("value",DADonateFormData[DADonateForm.action.value][DADonateForm.amount.value].data);' +
            'document.getElementById("liqpayFormSignature").setAttribute("value",DADonateFormData[DADonateForm.action.value][DADonateForm.amount.value].signature)' +
            '}' +
            'DADonateFormSetData();' +
            'function dadonateformchange(a) {' +
            'a.preventDefault(), a.stopPropagation();' +
            '        DADonateFormSetData()}' +
            '</script\>';

        result.value = result_settings_form + result_liqpay_form + resultScript;
        }

</script>

</body>
</html>
